"use strict";angular.module("jassemApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngSanitize","ngTouch","ui.router","ui.bootstrap","ui.codemirror"]).config(["$stateProvider","$locationProvider","$urlRouterProvider",function(a,b,c){b.html5Mode({enabled:!0,requireBase:!1}).hashPrefix("!"),c.otherwise(function(a,b){a.invoke(["$state",function(a){a.go("404")}])}),a.state("main",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).state("about",{url:"/about",templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).state("contact",{url:"/contact",templateUrl:"views/contact.html"}).state("404",{templateUrl:"404.html"})}]).run(["$rootScope","$state","$stateParams",function(a,b,c){a.$state=b,a.$stateParams=c}]),angular.module("jassemApp").controller("MainCtrl",["Program",function(a){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],this.testData=["foo","bar","foobar"],this.memory={r0:0,r1:0,r2:0,r3:0,r4:0,sp:16774216,fp:16774216,pc:4096,csr:0,stack:[{address:16774216,value:2,label:"",highlight:"both"}],global:[{address:4,value:2,label:"i",isActive:!1}]},this.code=[{address:4096,value:"push #4",label:"a:",isActive:!1}],this.error="",this.reset=function(){},this.compile=function(){this.error="",this.memory=a.compile(this.assemCode),this.code=a.parseCode(this.assemCode)},this.stepForward=function(){a.stepForward()},this.stepBackward=function(){this.error="",a.stepBackward()},this.runtimeStack=[{instruction:"push #4",reverse_instruction:"pop #4",fp:{to:50,from:35},sp:{to:50,from:35}}],this.assemblyEditorOptions={lineWrapping:!1,lineNumbers:!0,matchBrackets:!0,theme:"solarized light"},this.cCodeEditorOptions={lineWrapping:!1,lineNumbers:!0,theme:"solarized light",matchBrackets:!0,mode:"text/x-csrc"},this.letThereBeVIM=function(){this.assemblyEditorOptions.keyMap="vim",this.cCodeEditorOptions.keyMap="vim"},this.cCode="int a(int *p) {\n    return *p;\n}\n\nmain() {\n    int i, j;\n\n    j = 15;\n    i = a(&j);\n};",this.assemCode="a:\n    ld [fp+12] -> %r0      / get p's value\n    ld [r0] -> %r0         / dereference it\n    ret\n\nmain:\n    push #8\n\n    mov #15 -> %r0         / j = 15\n    st %r0 -> [fp]\n\n    st %fp -> [sp]--       / push &j on the stack\n    jsr a                  / and call a()\n    pop #4\n    st %r0 -> [fp-4]\n\n    ret"}]),angular.module("jassemApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("jassemApp").controller("FooterCtrl",["$scope",function(a){a.year=(new Date).getFullYear()}]),angular.module("jassemApp").filter("hex",function(){return function(a){return"0x"+Number(a).toString(16)}}),angular.module("jassemApp").service("Memory",function(){var a;this.memory=function(){return a},this.resetMemory=function(){a={r0:0,r1:0,r2:0,r3:0,r4:0,_sp:16774216,set sp(b){console.log("SP Setting");var d=c(a.sp),e=c(b);a.stack[d].highlight=a.fp==a.sp?"fp":"",a.stack[e].highlight=a.fp==b?"both":"sp",console.log("SP Set from "+a.sp.toString(16)+" to "+b.toString(16)),a._sp=b},_fp:16774216,get sp(){return a._sp},set fp(b){console.log("FP Setting");var d=c(a.fp),e=c(b);a.stack[d].highlight=a.sp==a.fp?"sp":"",a.stack[e].highlight=a.sp==b?"both":"fp",a._fp=b,console.log("FP Set from "+a.fp.toString(16)+" to "+b.toString(16))},get fp(){return a._fp},_pc:4096,set pc(b){console.log("PC Setting"),a._pc=b,console.log("PC Set from "+a.pc.toString(16)+" to "+b.toString(16))},get pc(){return a._pc},csr:0,stack:[{address:16774216,value:0,label:"",highlight:""}],global:[{address:4,value:2,label:"i",highlight:""}]},a.fp=16774216,a.sp=16774216,a.pc=4096};var b=function(b){void 0==b&&(b=1);for(var c=0;b>c;c++){var d=a.stack[a.stack.length-1].address;a.stack.push({address:d-4,value:0,label:"",highlight:""})}};this.setPC=function(b){a.pc=b};var c=function(b){for(var c=0;c<a.stack.length;c++)if(a.stack[c].address==b)return c;return-1},d=function(b,c){b=b.replace("%",""),a[b]=c},e=function(b){return b=b.replace("%",""),a[b]},f=function(a){return a.replace("#","")},g=function(d,e){if(void 0!=d){var f;"--"==d?f=a[e]-4:"++"==d&&(f=a[e]+4);var g=c(f);-1==g&&b(),a[e]=f}},h=function(b){var c=/^\[([a-z0-9]+)([+-])?([0-9]+)?\]([\-+]{2})?$/g,d=c.exec(b),e=d[1],f=a[e],h=d[2],i=d[3],j=d[4];if(void 0!=h&&void 0!=i){if("+"==h){var k=f+parseInt(i);return g(j,e),k}if("-"==h){var k=f-parseInt(i);return g(j,e),k}}return g(j,e),f},i=function(a){if("#"==a.charAt(0)){console.log("Pointer Detected");var b=f(a);return console.log("Constant Resolved: "+a+" converted to "+b),b}if(void 0!=a.match(/^\[([a-z]+)([+-])?([0-9]+)?\]([\-+]{2})?$/g)){console.log("Pointer Detected");var b=h(a);return console.log("Pointer Resolved: "+a+" converted to 0x"+b.toString(16)),b}},j=function(b,d){var e=c(d);a.stack[e].value=b},k=function(b){var d=c(b);return a.stack[d].value};this.ld=function(b){var e=b.args[0],f=b.args[1],g=i(e),h=c(g);console.log(h);var j=a.stack[h].value;console.log(j),d(f,j)},this.st=function(b){var d=b.args[0],f=b.args[1],g=i(f),h=c(g);a.stack[h].value=e(d)},this.push=function(c){for(var d=i(c.args[0])/4,e=0;d>e;e++)b(),a.sp-=4},this.pop=function(b){for(var c=i(b.args[0])/4,d=0;c>d;d++)a.sp+=4},this.jsr=function(c){b(3),j(a.pc+4,a.sp),a.sp-=4,j(a.fp,a.sp),a.sp-=4,a.fp=a.sp},this.ret=function(b){a.sp+=4,a.fp=k(a.sp),a.sp+=4,a.pc=k(a.sp)},this.cmp=function(a){},this.mov=function(a){var b=i(a.args[0]),c=a.args[1];d(c,b)},this.add=function(a){var b=a.args[0],c=a.args[1],f=a.args[2],g=parseInt(e(b)),h=parseInt(e(c)),i=g+h;d(f,i)},this.sub=function(a){var b=a.args[0],c=a.args[1],f=a.args[2],g=parseInt(e(b)),h=parseInt(e(c)),i=g-h;d(f,i)},this.mul=function(a){var b=a.args[0],c=a.args[1],f=a.args[2],g=parseInt(e(b)),h=parseInt(e(c)),i=g*h;d(f,i)},this.idiv=function(a){var b=a.args[0],c=a.args[1],f=a.args[2],g=parseInt(e(b)),h=parseInt(e(c)),i=Math.floor(g/h);d(f,i)},this.imod=function(a){var b=a.args[0],c=a.args[1],f=a.args[2],g=parseInt(e(b)),h=parseInt(e(c)),i=g%h;d(f,i)}}),angular.module("jassemApp").service("Program",["Memory",function(a){var b=null,c=0,d=void 0,e=4096,f=[{funcname:"ld",args:["i","%r0"],label:void 0}],g=[{address:4096,value:"push #4",label:"a:",isActive:!0},{address:4100,value:"ld [fp+12] -> %r0",label:"",isActive:!1},{address:4104,value:"ld [fp+16] -> %r1",label:"",isActive:!1}];this.code=function(){return g};var h=function(a){for(var b=0;b<g.length;b++)if(g[b].address==a)return b},i=function(a){for(var b=0;b<g.length;b++)if(g[b].label==a)return b-1};this.jumpToAddress=function(a){var b=h(a);console.log("new index = "+b);var d=h(e);console.log("old index = "+d),g[b].isActive=!0,g[d].isActive=!1,e=a,c=b},this.jumpToLabel=function(a){var b=i(a);console.log(b),console.log(c),g[b].isActive=!0,g[c].isActive=!1,e=g[b].address,c=b};var j=function(a){var b=a.funcname,c=a.args;switch(c.length){case 0:return b;case 1:return"{0} {1}".format(b,c[0]);case 2:return"cmp"==b?"{0} {1}, {2}".format(b,c[0],c[1]):"{0} {1} -> {2}".format(b,c[0],c[1]);case 3:return"{0} {1}, {2} -> {3}".format(b,c[0],c[1],c[2])}};this.operations=function(){return f},this.parseCode=function(b){g=[],f=[],e=4092;var c,d=b.split("\n");d.forEach(function(a){a=a.replace(/(\/+.*)/gm,""),a=a.trim(),c=k(a,0,""),void 0!=c&&(n(c),f.push(c))});var h=o();return a.setPC(g[h].address),this.code()};var k=function(a,b,c){var d=a.charAt(b);if("ret"==c){var e=l(a,0);return e}if(b!=a.length)switch(d){case":":return void m(c);case" ":switch(c){case"add":case"sub":case"mul":case"idiv":case"imod":return l(a,3);case"ld":case"st":case"cmp":case"mov":return l(a,2);case"push":case"pop":case"jsr":case"b":case"bge":return l(a,1)}default:return c=c.concat(d),k(a,b+1,c)}},l=function(a,b){var c;switch(b){case 0:c=/^(\S+)$/g;break;case 1:c=/^(\S+)\s+(\S+)$/g;break;case 2:c=/^(\S+)\s+(\S+)\s*(?:,|\->)\s*(\S+)$/g;break;case 3:c=/^(\S+)\s+(\S+)\s*,\s*(\S+)\s*->\s?(\S+)$/g}var e=c.exec(a),f={funcname:e[1],args:[],label:d};d=void 0;for(var g=2;5>g;g++)void 0!=e[g]&&f.args.push(e[g]);return f},m=function(a){d=a},n=function(a){var b={address:e+=4,value:j(a),isActive:!1,label:a.label};g.push(b)},o=function(){c=-1;for(var a=0;a<f.length;a++)if(void 0!=f[a]&&"main"==f[a].label){if(-1!=c)throw"Error: Code cannot have multiple main labels.";c=a,e=4096+4*c}if(-1==c)throw"Error: Code must have a main label";return g.forEach(function(a){a.isActive=!1}),g[c].isActive=!0,c};this.compile=function(c){return a.resetMemory(),b=a.memory()},this.stepForward=function(){if(c!=g.length-1){var b=f[c],d=b.funcname,h=b.args;if(console.log(b),"jsr"==d){var i=h[1];this.jumpToLabel(i),a[d](b)}else"ret"==d?(a[d](b),this.jumpToAddress(a.memory().pc)):(g[c].isActive=!1,c++,e+=4,g[c].isActive=!0,a[d](b));a.setPC(e)}},this.stepBackward=function(){0!=c&&(g[c].isActive=!1,c--,g[c].isActive=!0,a.setPC(e))},String.prototype.format=function(){for(var a=this,b=0;b<arguments.length;b++){var c="{"+b+"}";a=a.replace(c,arguments[b])}return a}}]),angular.module("jassemApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/main.html",'<div class="container-fluid theme-showcase" role="main"> <div class="col-sm-10 col-sm-offset-1"> <h1>CS360: Jassem Visualizer</h1> </div> <div class="col-sm-10 col-sm-offset-1 text-center"> <p>Assembly language created for educational use by <a target="-_blank" href="//web.eecs.utk.edu/~plank/">Dr. James Plank</a>, Computer Science professor at <a target="_blank" href="//www.utk.edu">University of Tennessee, Knoxville</a>.<br> Visualizer modified for web by Chris Martin and Mark Adams, COSC 360, Spring 2016, University of Tennessee, Knoxville.</p> </div> <div class="col-sm-6 col-sm-offset-3 well text-center"> <p><div>Enter your complete J-Assembly program in the text box below and then press compile.<br> Use the buttons below to step forwards, step backwards, animate, and reset. <br> There is a convenience textbox to the side for any C code needed for reference.</div></p> </div> <!-- Buttons --> <div class="col-sm-12 text-center"> <button type="button" class="btn btn btn-primary" ng-click="main.compile()">Compile</button> <!--<button type="button" class="btn btn btn-default" ng-click="main.stepBackward()">Step Backwards</button>--> <button type="button" class="btn btn btn-default" ng-click="main.stepForward()">Step Forward</button> <button type="button" class="btn btn btn-default">Animate</button> <button type="button" class="btn btn btn-danger" ng-click="main.reset()">Reset</button> <button type="button" class="btn btn btn-danger" ng-click="main.letThereBeVIM()">VIM!</button> </div> <!--<div ng-if="main.error" class="col-sm-12 text-center alert alert-danger" role="alert">{{main.error}}</div>--> <!-- Visualizer --> <div style="margin-bottom: 40px"> <div ng-class="{alert: main.error, \'alert-danger\': main.error}" class="col-sm-12 text-center" role="alert"> <div ng-if="main.error" class="col-sm-12 text-center" style="margin-bottom: 40px"><strong>{{main.error}}</strong></div> <div class="col-sm-4"> <h4 class="text-center">Stack</h4> <table class="col-xs-12" style="margin-bottom: 20px"> <tr ng-repeat="stackVar in main.memory.stack"> <td>{{stackVar.address | hex}}</td> <td ng-class="{\'sp-cell\': stackVar.highlight == \'sp\', \'fp-cell\': stackVar.highlight == \'fp\', \'both-cell\': stackVar.highlight == \'both\'}" class="boxEntry">{{stackVar.value | hex}}</td> </tr> </table> </div> <div class="col-sm-4"> <h4 class="text-center">Step</h4> <table class="col-xs-12" style="margin-bottom: 20px"> <tr> <td>CSR</td> <td class="boxEntry">0x0</td> </tr> </table> <h4 class="text-center">Registers</h4> <table class="col-xs-12" style="margin-bottom: 20px"> <tr> <td>r0</td> <td class="boxEntry">{{main.memory.r0 | hex}}</td> </tr> <tr> <td>r1</td> <td class="boxEntry">{{main.memory.r1 | hex}}</td> </tr> <tr> <td>r2</td> <td class="boxEntry">{{main.memory.r2 | hex}}</td> </tr> <tr> <td>r3</td> <td class="boxEntry">{{main.memory.r3 | hex}}</td> </tr> <tr> <td>r4</td> <td class="boxEntry">{{main.memory.r4 | hex}}</td> </tr> <tr> <td>sp</td> <td ng-class="{\'sp-cell\': 1}" class="boxEntry">{{main.memory.sp | hex}}</td> </tr> <tr> <td>fp</td> <td ng-class="{\'fp-cell\': 1}" class="boxEntry">{{main.memory.fp | hex}}</td> </tr> <tr> <td>pc</td> <td ng-class="{\'active-cell\': 1}" class="boxEntry">{{main.memory.pc | hex}}</td> </tr> </table> <h4 class="text-center">Globals</h4> <table class="col-xs-12" style="margin-bottom: 20px"> <tr ng-repeat="globalVar in main.memory.global"> <td>{{globalVar.address | hex}}</td> <td class="boxEntry">{{globalVar.value | hex}}</td> </tr> </table> </div> <div class="col-sm-4"> <h4 class="text-center">Code</h4> <table class="col-xs-12" style="margin-bottom: 20px"> <tr ng-repeat="codeVar in main.code"> <td>{{codeVar.address | hex}}</td> <td ng-class="{\'active-cell\': codeVar.isActive === true}" class="boxEntry">{{codeVar.value}}</td> <td>{{codeVar.label}}</td> </tr> </table> </div> </div> </div> <!--Code Boxes--> <div class="col-sm-10 col-sm-offset-1 row"> <div class="col"> <h3><center>Assembly Code</center></h3> </div> <div class="col"> <h3><center>C Code</center></h3> </div> </div> <div class="col-sm-10 col-sm-offset-1 row" style="margin-bottom: 20px"> <section style="border-style: solid; border-width: 1px" class="col-sm-6"> <ui-codemirror ui-codemirror-opts="main.assemblyEditorOptions" ng-model="main.assemCode"></ui-codemirror> </section> <section style="border-style: solid; border-width: 1px" class="col-sm-5 col-sm-offset-1"> <ui-codemirror ui-codemirror-opts="main.cCodeEditorOptions" ng-model="main.cCode"></ui-codemirror> </section> </div> <script>var mac = CodeMirror.keyMap.default == CodeMirror.keyMap.macDefault;\n    CodeMirror.keyMap.default[(mac ? "Cmd" : "Ctrl") + "-Space"] = "autocomplete";</script> </div>')}]);